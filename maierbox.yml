Parameters:
  DBAdminUsername:
    Type: String
    Default: admin
  VPCID:
    Type: AWS::EC2::VPC::Id
  Subnets:
    Type: CommaDelimitedList
Resources:
  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for the MaierBox containers running on ECS
      GroupName: maierbox
      VpcId: !Ref VPCID
  ECSService:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref ECSCluster
      DeploymentController: 
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: false
      LaunchType: FARGATE
      LoadBalancers: 
        - ContainerName: nginx
          ContainerPort: 80
          TargetGroupArn: !Ref ECSTargetGroup
      NetworkConfiguration: 
        AwsvpcConfiguration: 
            AssignPublicIp: DISABLED
            SecurityGroups: 
              - !Ref ECSSecurityGroup
            Subnets: !Ref Subnets
      PlatformVersion: LATEST
      SchedulingStrategy: REPLICA
      ServiceConnectConfiguration: 
        Enabled: false
      ServiceName: maierbox
      TaskDefinition: !Ref ECSTaskDefinition
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      CapacityProviders: 
        - FARGATE
      ClusterName: maierbox
      ClusterSettings: 
        - Name: containerInsights
          Value: disabled
  ECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions: 
        - DisableNetworking: false
          Environment: 
            - Name: MYSQL_HOST
              Value:
                Fn::GetAtt: DBCluster.Endpoint.Address
            - Name: MYSQL_PORT
              Value:
                Fn::GetAtt: DBCluster.Endpoint.Port
          Essential: true
          HealthCheck: 
              Command: 
                - "CMD-SHELL, curl -f http://localhost:8000 || exit 1"
          Hostname: maierbox
          Image:
            Fn::Sub: '${MaierBoxRepo.RepositoryUri}/maierbox:latest'
          Interactive: false
          MountPoints: 
            - ContainerPath: /opt/maierbox/static
              ReadOnly: false
              SourceVolume: static
            - ContainerPath: /opt/maierbox/media
              ReadOnly: false
              SourceVolume: media
          Name: maierbox
          Privileged: false
          ReadonlyRootFilesystem: true
          Secrets: 
            - Name: MYSQL_USER
              ValueFrom: 
                Fn::Sub: "${DBAdmin}:SecretString:username"
            - Name: MYSQL_PASS
              ValueFrom:
                Fn::Sub: "${DBAdmin}:SecretString:password"
            - Name: MAIERBOX_SECRET
              ValueFrom: !Ref MaierBoxSecret
        - DependsOn:
            - Condition: HEALTHY
              ContainerName: maierbox
          DisableNetworking: false
          Essential: true
          HealthCheck: 
              Command: 
                - "CMD-SHELL, curl -f http://localhost/ || exit 1"
          Hostname: nginx
          Image:
            Fn::Sub: '${NGINXRepo.RepositoryUri}/nginx:latest'
          Interactive: false
          MountPoints: 
            - ContainerPath: /mnt/static
              ReadOnly: false
              SourceVolume: static
            - ContainerPath: /mnt/media
              ReadOnly: false
              SourceVolume: media
          Name: nginx
          PortMappings:
            - AppProtocol: http
              ContainerPort: 80
              HostPort: 80
              Protocol: tcp
          Privileged: false
          ReadonlyRootFilesystem: true
      Cpu: 512
      Memory: 2048
      NetworkMode: awsvpc
      PidMode: task
      RequiresCompatibilities: 
        - FARGATE
      RuntimePlatform: 
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Volumes: 
        - ConfiguredAtLaunch: false
          EFSVolumeConfiguration:
              FilesystemId: !Ref ElasticFileSystem
              RootDirectory: '/static/'
              TransitEncryption: DISABLED
          Name: static
        - ConfiguredAtLaunch: false
          EFSVolumeConfiguration:
              FilesystemId: !Ref ElasticFileSystem
              RootDirectory: '/media/'
              TransitEncryption: DISABLED
          Name: media
  MaierBoxRepo:
    Type: AWS::ECR::Repository
    Properties:
      EmptyOnDelete: true
      ImageTagMutability: MUTABLE
      RepositoryName: maierbox
  NGINXRepo:
    Type: AWS::ECR::Repository
    Properties:
      EmptyOnDelete: true
      ImageTagMutability: MUTABLE
      RepositoryName: nginx
  MaierBoxSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: SECRET_KEY for MaierBox/Django
      GenerateSecretString:
        PasswordLength: 64
        RequireEachIncludedType: true
      Name: MaierBoxSecret
  DBAdmin:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: Credentials for the Admin User of the MaierBox DB
      GenerateSecretString:
        ExcludePunctuation: true
        GenerateStringKey: password
        PasswordLength: 32
        RequireEachIncludedType: true
        SecretStringTemplate: !Sub '{"username": "${DBAdminUsername}"}'
      Name: MaierBoxDBAdmin
  DBCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DBClusterIdentifier: MaierBoxDB
      DeletionProtection: true
      EnableHttpEndpoint: false
      Engine: aurora-mysql
      EngineMode: provisioned
      EngineVersion: 8.0.mysql_aurora.3.07.1
      MasterUsername:
        Fn::Sub: "{{resolve:secretsmanager:${DBAdmin}::username}}"
      MasterUserPassword:
        Fn::Sub: "{{resolve:secretsmanager:${DBAdmin}::password}}"
      ServerlessV2ScalingConfiguration: 
          MaxCapacity: 1
          MinCapacity: 0.5
  DBInstance:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      Engine: aurora-mysql
      DBInstanceClass: db.serverless
      DBClusterIdentifier: !Ref DBCluster
  ElasticFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      BackupPolicy: 
        Status: ENABLED
      Encrypted: false
      FileSystemProtection: 
        ReplicationOverwriteProtection: ENABLED
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties: {}
  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: <String>
      DefaultActions:
        - Type: <String>
  HTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: <String>
      DefaultActions:
        - Type: <String>
  ListenerCertificate:
    Type: AWS::ElasticLoadBalancingV2::ListenerCertificate
    Properties:
      Certificates:
        - {}
      ListenerArn: <String>
  ECSTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckEnabled: Boolean
      HealthCheckIntervalSeconds: Integer
      HealthCheckPath: String
      HealthCheckPort: String
      HealthCheckProtocol: String
      HealthCheckTimeoutSeconds: Integer
      HealthyThresholdCount: Integer
      IpAddressType: String
      Matcher: 
        Matcher
      Name: String
      Port: Integer
      Protocol: String
      ProtocolVersion: String
      Tags: 
        - Tag
      TargetGroupAttributes: 
        - TargetGroupAttribute
      Targets: 
        - TargetDescription
      TargetType: String
      UnhealthyThresholdCount: Integer
      VpcId: String
